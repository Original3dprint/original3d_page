<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sievert Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .kanban-column {
            min-height: 200px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center space-x-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-blue-600" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 10.586V6z" clip-rule="evenodd" />
            </svg>
            <h1 class="text-xl md:text-2xl font-bold text-gray-800">Sievert Control</h1>
        </div>
        <div class="flex items-center space-x-2 md:space-x-4">
            <div class="flex bg-gray-200 rounded-lg p-1">
                <button id="view-kanban-btn" class="px-3 py-1 text-sm font-medium rounded-md transition-colors bg-blue-600 text-white shadow">
                    Kanban
                </button>
                <button id="view-agenda-btn" class="px-3 py-1 text-sm font-medium rounded-md transition-colors text-gray-600 hover:bg-gray-300">
                    Agenda
                </button>
            </div>
            <button id="add-instrument-btn" class="flex items-center bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 transition-colors shadow">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                <span class="hidden md:inline">Añadir Instrumento</span>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="p-4 md:p-6">
        <!-- Content will be rendered here by JavaScript -->
    </main>

    <!-- Add Instrument Modal -->
    <div id="add-instrument-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md relative max-h-full overflow-y-auto">
            <button id="close-add-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 z-10">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4">Añadir Nuevo Instrumento</h2>
            <form id="add-instrument-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ID del Instrumento</label>
                    <input type="text" id="instrument-id-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nombre del Cliente</label>
                    <input type="text" id="client-name-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fecha Programada de Recolección</label>
                    <input type="date" id="collection-date-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Fecha Prometida de Entrega</label>
                    <div class="flex items-center space-x-2">
                        <input type="date" id="delivery-date-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
                        <button type="button" id="suggest-date-btn" class="mt-1 flex items-center px-3 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 disabled:bg-purple-300">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v1h-2V4H7v1H5V4zM5 7h10v9a2 2 0 01-2 2H7a2 2 0 01-2-2V7z" /></svg>
                            <span id="suggest-date-btn-text">Sugerir</span>
                        </button>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-add-modal-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Añadir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Instrument Detail Modal -->
    <div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4 hidden">
        <div id="detail-modal-content" class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-md relative max-h-full overflow-y-auto">
            <!-- Details will be rendered here -->
        </div>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, Timestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : { apiKey: "your-api-key", authDomain: "your-auth-domain", projectId: "your-project-id" };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'sievert-control-default';
        
        // --- Global State ---
        let db;
        let auth;
        let userId;
        let instruments = [];
        let currentView = 'kanban'; // 'kanban' or 'agenda'
        let currentDate = new Date();
        let draggedItemId = null;

        // --- DOM Elements ---
        const mainContent = document.getElementById('main-content');
        const viewKanbanBtn = document.getElementById('view-kanban-btn');
        const viewAgendaBtn = document.getElementById('view-agenda-btn');
        const addInstrumentBtn = document.getElementById('add-instrument-btn');
        const addInstrumentModal = document.getElementById('add-instrument-modal');
        const closeAddModalBtn = document.getElementById('close-add-modal-btn');
        const cancelAddModalBtn = document.getElementById('cancel-add-modal-btn');
        const addInstrumentForm = document.getElementById('add-instrument-form');
        const detailModal = document.getElementById('detail-modal');
        const suggestDateBtn = document.getElementById('suggest-date-btn');

        // --- Gemini API Helper ---
        async function callGeminiAPI(prompt) {
            const apiKey = ""; // The environment will provide the key
            const url = https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey};
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(API request failed with status ${response.status});
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts[0]) {
                    return result.candidates[0].content.parts[0].text;
                }
                return "No se pudo obtener una respuesta válida de la IA.";
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                throw error;
            }
        }

        // --- Rendering Functions ---
        function render() {
            mainContent.innerHTML = '<p class="text-center text-lg">Cargando...</p>';
            if (currentView === 'kanban') {
                renderKanbanBoard();
            } else {
                renderAgendaView();
            }
        }

        function renderKanbanBoard() {
            const KANBAN_COLUMNS = [
                { id: 'En Recepción', title: 'En Recepción' },
                { id: 'En Proceso', title: 'En Proceso' },
                { id: 'Calibrado', title: 'Calibrado' },
                { id: 'Listo para Despacho', title: 'Listo para Despacho' },
                { id: 'Despachado', title: 'Despachado' },
            ];

            let boardHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">';
            KANBAN_COLUMNS.forEach(column => {
                const columnInstruments = instruments.filter(inst => inst.status === column.id);
                boardHTML += `
                    <div class="bg-gray-200 rounded-lg p-3 kanban-column" data-status="${column.id}">
                        <h2 class="font-bold text-lg mb-4 text-gray-700 text-center">${column.title}</h2>
                        <div class="space-y-3">
                            ${columnInstruments.map(inst => `
                                <div class="bg-white p-3 rounded-lg shadow-sm cursor-pointer hover:shadow-md transition-shadow border-l-4 border-blue-500 flex items-start" draggable="true" data-id="${inst.id}">
                                    <div class="flex-grow">
                                        <p class="font-semibold text-gray-800">${inst.instrumentId}</p>
                                        <p class="text-sm text-gray-600">${inst.clientName}</p>
                                    </div>
                                    <div class="text-gray-400 cursor-grab">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });
            boardHTML += '</div>';
            mainContent.innerHTML = boardHTML;
            addKanbanEventListeners();
        }

        function renderAgendaView() {
            const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDay = startOfMonth.getDay();
            const daysInMonth = endOfMonth.getDate();
            const weekDays = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];

            let agendaHTML = `
                <div class="bg-white p-4 rounded-lg shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                        <h2 class="text-xl font-bold">${currentDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' }).replace(/^\w/, c => c.toUpperCase())}</h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-center font-semibold text-gray-600">
                        ${weekDays.map(day => <div class="py-2">${day}</div>).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1">
            `;
            
            for (let i = 0; i < startDay; i++) {
                agendaHTML += '<div class="border rounded-md h-28"></div>';
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const day = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                const isToday = day.toDateString() === new Date().toDateString();
                const events = instruments.filter(inst => {
                    const collectionDate = inst.scheduledCollectionDate?.toDate();
                    const deliveryDate = inst.promisedDeliveryDate?.toDate();
                    return (collectionDate && collectionDate.toDateString() === day.toDateString()) || (deliveryDate && deliveryDate.toDateString() === day.toDateString());
                });

                agendaHTML += `
                    <div class="border rounded-md h-32 p-1 overflow-y-auto ${isToday ? 'bg-blue-50' : ''}">
                        <div class="font-bold ${isToday ? 'text-blue-600' : 'text-gray-700'}">${i}</div>
                        <div class="space-y-1 mt-1">
                            ${events.map(event => {
                                const isCollection = event.scheduledCollectionDate?.toDate().toDateString() === day.toDateString();
                                return `
                                    <div data-id="${event.id}" class="text-xs p-1 rounded cursor-pointer ${isCollection ? 'bg-yellow-200 text-yellow-800' : 'bg-green-200 text-green-800'}">
                                        ${isCollection ? 'Recoger: ' : 'Entregar: '} ${event.instrumentId}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            agendaHTML += '</div></div>';
            mainContent.innerHTML = agendaHTML;
            addAgendaEventListeners();
        }
        
        // --- Modal Rendering ---
        function renderDetailModal(instrument) {
            const formatDate = (timestamp) => {
                if (!timestamp) return 'N/A';
                return timestamp.toDate().toLocaleString('es-CO', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            };
            
            const historyHTML = instrument.history ? instrument.history.slice().reverse().map(entry => 
                <li class="text-sm"><span class="font-semibold">${entry.status}</span> - ${formatDate(entry.date)}</li>
            ).join('') : '';

            const contentHTML = `
                <button id="close-detail-modal-btn" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 z-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <h2 class="text-2xl font-bold mb-2">${instrument.instrumentId}</h2>
                <p class="text-lg text-gray-600 mb-4">${instrument.clientName}</p>
                <div class="space-y-3 mb-6">
                    <p><strong>Estado Actual:</strong> <span class="font-semibold text-blue-600">${instrument.status}</span></p>
                    <p><strong>Fecha de Recepción:</strong> ${formatDate(instrument.receptionDate)}</p>
                    <p><strong>Última Actualización:</strong> ${formatDate(instrument.lastUpdate)}</p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <button id="generate-email-btn" class="w-full flex items-center justify-center bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors shadow disabled:bg-indigo-300">
                        ✨ Generar Notificación al Cliente
                    </button>
                    <div id="email-generation-result" class="mt-4 hidden">
                        <textarea readonly id="generated-email-textarea" class="w-full h-48 p-2 border rounded-md bg-white font-mono text-sm"></textarea>
                        <button id="copy-email-btn" class="mt-2 flex items-center justify-center w-full bg-gray-600 text-white px-3 py-1.5 rounded-md hover:bg-gray-700 text-sm">
                            Copiar al Portapapeles
                        </button>
                    </div>
                </div>
                <div class="flex justify-end pt-6">
                    <button id="close-detail-modal-bottom-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Cerrar</button>
                </div>
            `;
            document.getElementById('detail-modal-content').innerHTML = contentHTML;
            addDetailModalEventListeners(instrument);
            detailModal.classList.remove('hidden');
        }

        // --- Event Listeners ---
        function addKanbanEventListeners() {
            document.querySelectorAll('[draggable="true"]').forEach(card => {
                card.addEventListener('dragstart', e => {
                    draggedItemId = e.target.dataset.id;
                });
                card.addEventListener('click', e => {
                    const instrument = instruments.find(inst => inst.id === e.currentTarget.dataset.id);
                    if(instrument) renderDetailModal(instrument);
                });
            });

            document.querySelectorAll('.kanban-column').forEach(column => {
                column.addEventListener('dragover', e => e.preventDefault());
                column.addEventListener('drop', async e => {
                    e.preventDefault();
                    if (draggedItemId) {
                        const newStatus = e.currentTarget.dataset.status;
                        await updateInstrumentStatus(draggedItemId, newStatus);
                        draggedItemId = null;
                    }
                });
            });
        }
        
        function addAgendaEventListeners() {
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                render();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                render();
            });
            document.querySelectorAll('[data-id]').forEach(el => {
                 el.addEventListener('click', e => {
                    const instrument = instruments.find(inst => inst.id === e.currentTarget.dataset.id);
                    if(instrument) renderDetailModal(instrument);
                });
            });
        }
        
        function addDetailModalEventListeners(instrument) {
            const closeModal = () => detailModal.classList.add('hidden');
            document.getElementById('close-detail-modal-btn').addEventListener('click', closeModal);
            document.getElementById('close-detail-modal-bottom-btn').addEventListener('click', closeModal);

            const generateBtn = document.getElementById('generate-email-btn');
            generateBtn.addEventListener('click', async () => {
                generateBtn.textContent = 'Generando...';
                generateBtn.disabled = true;
                const prompt = `
                    Actúa como el asistente de comunicaciones del Laboratorio de Calibración Dosimétrica Sievert en Medellín.
                    Genera un correo electrónico corto, profesional y amigable en español para notificar a un cliente sobre el estado de su equipo.
                    Datos del Equipo: Cliente: ${instrument.clientName}, ID: ${instrument.instrumentId}, Estado: ${instrument.status}.
                    El correo debe: 1. Asunto claro. 2. Saludo. 3. Informar estado. 4. Si es "Listo para Despacho", mencionar coordinación de entrega. 5. Si es "Calibrado", mencionar que se procesa el certificado. 6. Despedida cordial.
                    No incluyas placeholders.`;
                try {
                    const emailText = await callGeminiAPI(prompt);
                    const resultContainer = document.getElementById('email-generation-result');
                    const textArea = document.getElementById('generated-email-textarea');
                    textArea.value = emailText;
                    resultContainer.classList.remove('hidden');
                } catch(e) {
                    alert('Error al generar el correo.');
                } finally {
                    generateBtn.textContent = '✨ Generar Notificación al Cliente';
                    generateBtn.disabled = false;
                }
            });
            
            document.getElementById('copy-email-btn').addEventListener('click', () => {
                const textArea = document.getElementById('generated-email-textarea');
                textArea.select();
                document.execCommand('copy');
                const btn = document.getElementById('copy-email-btn');
                btn.textContent = '¡Copiado!';
                setTimeout(() => { btn.textContent = 'Copiar al Portapapeles'; }, 2000);
            });
        }

        // --- Data Functions ---
        async function updateInstrumentStatus(instrumentId, newStatus) {
            const instrumentRef = doc(db, /artifacts/${appId}/public/data/instruments, instrumentId);
            const instrument = instruments.find(inst => inst.id === instrumentId);
            const newHistoryEntry = { status: newStatus, date: Timestamp.now(), user: userId || 'anonymous' };
            const updatedHistory = instrument.history ? [...instrument.history, newHistoryEntry] : [newHistoryEntry];
            try {
                await updateDoc(instrumentRef, { status: newStatus, lastUpdate: Timestamp.now(), history: updatedHistory });
            } catch (err) {
                console.error("Error updating instrument:", err);
                alert("Error al actualizar el instrumento.");
            }
        }

        // --- App Initialization ---
        function initializeAppLogic() {
            // View switcher
            viewKanbanBtn.addEventListener('click', () => {
                currentView = 'kanban';
                viewKanbanBtn.classList.add('bg-blue-600', 'text-white', 'shadow');
                viewAgendaBtn.classList.remove('bg-blue-600', 'text-white', 'shadow');
                render();
            });
            viewAgendaBtn.addEventListener('click', () => {
                currentView = 'agenda';
                viewAgendaBtn.classList.add('bg-blue-600', 'text-white', 'shadow');
                viewKanbanBtn.classList.remove('bg-blue-600', 'text-white', 'shadow');
                render();
            });

            // Modal controls
            const openAddModal = () => addInstrumentModal.classList.remove('hidden');
            const closeAddModal = () => addInstrumentModal.classList.add('hidden');
            addInstrumentBtn.addEventListener('click', openAddModal);
            closeAddModalBtn.addEventListener('click', closeAddModal);
            cancelAddModalBtn.addEventListener('click', closeAddModal);

            // Add instrument form
            addInstrumentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const instrumentId = document.getElementById('instrument-id-input').value;
                const clientName = document.getElementById('client-name-input').value;
                const collectionDate = document.getElementById('collection-date-input').value;
                const deliveryDate = document.getElementById('delivery-date-input').value;

                const newInstrument = {
                    instrumentId,
                    clientName,
                    scheduledCollectionDate: collectionDate ? Timestamp.fromDate(new Date(collectionDate)) : null,
                    promisedDeliveryDate: deliveryDate ? Timestamp.fromDate(new Date(deliveryDate)) : null,
                    receptionDate: Timestamp.now(),
                    lastUpdate: Timestamp.now(),
                    status: 'En Recepción',
                    history: [{ status: 'En Recepción', date: Timestamp.now(), user: userId || 'anonymous' }]
                };
                try {
                    await addDoc(collection(db, /artifacts/${appId}/public/data/instruments), newInstrument);
                    addInstrumentForm.reset();
                    closeAddModal();
                } catch (err) {
                    console.error("Error adding instrument:", err);
                    alert("Error al añadir el nuevo instrumento.");
                }
            });
            
            // Suggest date button
            suggestDateBtn.addEventListener('click', async () => {
                const btnText = document.getElementById('suggest-date-btn-text');
                suggestDateBtn.disabled = true;
                btnText.textContent = '...';
                const enProcesoCount = instruments.filter(i => i.status === 'En Proceso').length;
                const enRecepcionCount = instruments.filter(i => i.status === 'En Recepción').length;
                const prompt = `
                    Eres un asistente de planificación para un laboratorio de calibración en Medellín, Colombia.
                    La fecha actual es: ${new Date().toLocaleDateString('es-CO')}.
                    Carga de trabajo actual: ${enProcesoCount} en proceso, ${enRecepcionCount} en recepción.
                    Considera un tiempo de calibración promedio de 3 días hábiles y 2 días administrativos.
                    Sugiere una fecha de entrega realista para un nuevo instrumento.
                    Responde únicamente con la fecha en formato YYYY-MM-DD.`;
                try {
                    const suggestedDate = await callGeminiAPI(prompt);
                    if (/^\d{4}-\d{2}-\d{2}$/.test(suggestedDate.trim())) {
                        document.getElementById('delivery-date-input').value = suggestedDate.trim();
                    } else {
                        alert("La IA devolvió un formato de fecha no válido.");
                    }
                } catch (error) {
                    alert("Error al contactar al asistente de IA.");
                } finally {
                    suggestDateBtn.disabled = false;
                    btnText.textContent = 'Sugerir';
                }
            });

            // Firebase connection
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Subscribe to data once authenticated
                        const instrumentsCollectionPath = /artifacts/${appId}/public/data/instruments;
                        const q = query(collection(db, instrumentsCollectionPath));
                        onSnapshot(q, (querySnapshot) => {
                            instruments = [];
                            querySnapshot.forEach((doc) => {
                                instruments.push({ id: doc.id, ...doc.data() });
                            });
                            render();
                        }, (err) => {
                            console.error("Error fetching data:", err);
                            mainContent.innerHTML = <p class="text-center text-red-500 bg-red-100 p-3 rounded-lg">No se pudieron cargar los datos.</p>;
                        });
                    } else {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                mainContent.innerHTML = <p class="text-center text-red-500 bg-red-100 p-3 rounded-lg">Error al inicializar la aplicación.</p>;
            }
        }

        // Start the app when the DOM is ready
        document.addEventListener('DOMContentLoaded', initializeAppLogic);
    </script>

</body>
</html>